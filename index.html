<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="manifest.json">
  <title>Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { 
      background: #000; 
      color: #fff; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .wrap {
      position: relative;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: #000;
    }
    
    #player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    #hlsPlayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      display: none;
    }
    
    #hlsPlayer.active {
      display: block;
    }
    
    .loader {
      position: absolute;
      inset: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .loader.hide { display: none; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }
    .loader-text {
      margin-top: 12px;
      font-size: 13px;
      color: #888;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .ui {
      position: absolute;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }
    .ui > * { pointer-events: auto; }
    
    .top {
      padding: 12px 15px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .ui.visible .top { opacity: 1; }
    
    .nav-btn {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }
    .nav-btn:active { background: rgba(255,255,255,0.3); }
    .nav-btn svg { width: 20px; height: 20px; fill: currentColor; }
    
    .nav-btn.refresh-btn { background: rgba(34, 197, 94, 0.3); }
    .nav-btn.refresh-btn:active { background: rgba(34, 197, 94, 0.5); }
    .nav-btn.refresh-btn.spinning svg { animation: spin 1s linear infinite; }
    
    .nav-btn.search-btn { background: rgba(59, 130, 246, 0.3); }
    .nav-btn.search-btn:active { background: rgba(59, 130, 246, 0.5); }
    
    .nav-btn.live-btn { background: rgba(239, 68, 68, 0.3); position: relative; }
    .nav-btn.live-btn:active { background: rgba(239, 68, 68, 0.5); }
    .nav-btn.live-btn .live-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .info {
      flex: 1;
      text-align: center;
      min-width: 0;
      padding: 0 5px;
    }
    .video-title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .video-count {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }
    .video-count.live-indicator {
      color: #ef4444;
      font-weight: 600;
    }
    
    .center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      pointer-events: auto;
    }
    
    .play-big {
      width: 70px;
      height: 70px;
      background: rgba(0,0,0,0.7);
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 60;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .play-big svg { width: 30px; height: 30px; fill: #fff; margin-left: 4px; }
    .ui.visible .play-big { opacity: 1; }
    .play-big:active { transform: scale(0.9); }
    
    .tap-ind {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
    }
    .tap-ind.left { left: 12%; }
    .tap-ind.right { right: 12%; }
    .tap-ind.show { opacity: 1; }
    
    .bottom {
      padding: 12px 15px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .ui.visible .bottom { opacity: 1; }
    
    .prog-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .time {
      font-size: 11px;
      color: #aaa;
      min-width: 38px;
      font-variant-numeric: tabular-nums;
    }
    .time.right { text-align: right; }
    
    .prog-bar {
      flex: 1;
      height: 24px;
      background: transparent;
      position: relative;
      cursor: pointer;
      touch-action: none;
      display: flex;
      align-items: center;
    }
    .prog-track {
      position: absolute;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
    }
    .prog-fill {
      position: absolute;
      left: 0;
      height: 4px;
      background: #e11d48;
      border-radius: 2px;
      pointer-events: none;
    }
    .prog-thumb {
      position: absolute;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.15s;
    }
    .prog-bar:hover .prog-thumb,
    .prog-bar.dragging .prog-thumb,
    .ui.visible .prog-thumb { opacity: 1; }
    .prog-bar.dragging .prog-track,
    .prog-bar.dragging .prog-fill { height: 6px; }
    
    /* Live mode hides progress */
    .bottom.live-mode .prog-wrap { display: none; }
    
    .ctrls {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .ctrl-grp {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .ctrl-btn {
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 50%;
    }
    .ctrl-btn:active { background: rgba(255,255,255,0.15); }
    .ctrl-btn svg { width: 22px; height: 22px; fill: currentColor; }
    .ctrl-btn.on { color: #22c55e; }
    .ctrl-btn.spd { font-size: 12px; font-weight: 700; width: auto; padding: 0 10px; }
    
    .drawer-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .drawer-bg.open { opacity: 1; pointer-events: auto; }
    
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px;
      max-width: 85vw;
      height: 100%;
      background: #111;
      z-index: 201;
      transform: translateX(100%);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    
    .drawer-head {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .drawer-head h3 { font-size: 15px; font-weight: 600; }
    
    .drawer-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .pl-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #222;
      cursor: pointer;
    }
    .pl-item:active { background: #222; }
    .pl-item.active { background: #1a365d; border-left: 3px solid #3b82f6; }
    .pl-item .num {
      font-size: 12px;
      font-weight: 600;
      color: #3b82f6;
      min-width: 22px;
    }
    .pl-item .name {
      flex: 1;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pl-item .name.loading {
      color: #666;
      font-style: italic;
    }
    
    /* Search Modal */
    .search-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.98);
      z-index: 300;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .search-modal.open { opacity: 1; pointer-events: auto; }
    
    .search-header {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-input-wrap {
      flex: 1;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      background: #222;
      border: 1px solid #444;
      border-radius: 25px;
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    .search-input:focus { border-color: #3b82f6; }
    .search-input::placeholder { color: #666; }
    
    .search-submit {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 34px;
      height: 34px;
      background: #3b82f6;
      border: none;
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .search-submit:active { background: #2563eb; }
    .search-submit svg { width: 18px; height: 18px; fill: currentColor; }
    
    .search-close {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }
    .search-close:active { background: rgba(255,255,255,0.2); }
    .search-close svg { width: 22px; height: 22px; fill: currentColor; }
    
    .search-history {
      padding: 10px 15px;
      border-bottom: 1px solid #222;
      background: #0a0a0a;
    }
    .search-history-title {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .search-history-title button {
      background: none;
      border: none;
      color: #f87171;
      font-size: 11px;
      cursor: pointer;
      padding: 2px 6px;
    }
    .search-history-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .search-chip {
      background: #222;
      border: 1px solid #333;
      color: #aaa;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .search-chip:active { background: #333; }
    .search-chip svg { width: 12px; height: 12px; fill: currentColor; }
    
    .search-info {
      padding: 10px 15px;
      font-size: 12px;
      color: #888;
      border-bottom: 1px solid #222;
      background: #0a0a0a;
    }
    
    .search-results {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
    }
    
    .search-empty {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }
    .search-empty svg {
      width: 70px;
      height: 70px;
      fill: #333;
      margin-bottom: 15px;
    }
    .search-empty p { font-size: 14px; line-height: 1.5; }
    
    .search-loading {
      text-align: center;
      padding: 50px 20px;
    }
    .search-loading .spinner { margin: 0 auto 15px; }
    .search-loading p { color: #888; font-size: 13px; }
    
    .search-result-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .search-result-item:active { background: #2a2a2a; }
    
    .search-thumb {
      width: 140px;
      height: 79px;
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }
    .search-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .search-thumb .duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.85);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .search-result-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .search-result-title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .search-result-channel {
      font-size: 11px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .search-result-meta {
      font-size: 11px;
      color: #666;
    }
    
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 13px;
      z-index: 400;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      max-width: 90%;
      text-align: center;
    }
    .toast.show { opacity: 1; }
    
    .err-box {
      text-align: center;
      padding: 20px;
    }
    .err-box p { margin-bottom: 15px; color: #f87171; }
    .err-box button {
      padding: 10px 25px;
      background: #333;
      border: none;
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .install-bar {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      padding: 10px 16px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 500;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    .install-bar.hide { display: none; }
    .install-bar svg { width: 18px; height: 18px; fill: #fff; flex-shrink: 0; }
    .install-bar span { color: #fff; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .install-bar .i-btn {
      background: #fff;
      color: #3b82f6;
      border: none;
      padding: 6px 14px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .install-bar .i-close {
      background: rgba(255,255,255,0.25);
      border: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .install-bar .i-close svg { width: 12px; height: 12px; }
    
    .status {
      position: fixed;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.8);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      color: #888;
      z-index: 1000;
      display: none;
    }
    .status.show { display: block; }
    .status.success { background: rgba(34, 197, 94, 0.9); color: white; }
    .status.error { background: rgba(239, 68, 68, 0.9); color: white; }
    
    /* History Button */
    .nav-btn.history-btn { background: rgba(168, 85, 247, 0.3); }
    .nav-btn.history-btn:active { background: rgba(168, 85, 247, 0.5); }
    
    /* History Modal */
    .history-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.98);
      z-index: 300;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .history-modal.open { opacity: 1; pointer-events: auto; }
    .history-header {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-header h3 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-header h3 svg { width: 20px; height: 20px; fill: #a855f7; }
    .history-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-clear {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #f87171;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      cursor: pointer;
    }
    .history-clear:active { background: rgba(239, 68, 68, 0.4); }
    
    .history-content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
    }
    
    .history-empty {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }
    .history-empty svg {
      width: 70px;
      height: 70px;
      fill: #333;
      margin-bottom: 15px;
    }
    .history-empty p { font-size: 14px; line-height: 1.5; }
    
    .history-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }
    .history-item:active { background: #2a2a2a; }
    
    .history-item-thumb {
      width: 120px;
      height: 68px;
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }
    .history-item-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .history-item-thumb .duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.85);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .history-item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .history-item-title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .history-item-channel {
      font-size: 11px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .history-item-time {
      font-size: 10px;
      color: #666;
    }
    
    .history-item-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: rgba(239, 68, 68, 0.8);
      border: none;
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .history-item:hover .history-item-delete,
    .history-item:active .history-item-delete { opacity: 1; }
    .history-item-delete svg { width: 14px; height: 14px; fill: currentColor; }
    
    /* Live Channels Modal */
    .live-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.98);
      z-index: 300;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .live-modal.open { opacity: 1; pointer-events: auto; }
    
    .live-header {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .live-header h3 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .live-header h3 svg { width: 20px; height: 20px; fill: #ef4444; }
    .live-header h3 .live-badge {
      background: #ef4444;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .live-content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
    }
    
    .live-empty {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }
    .live-empty svg {
      width: 70px;
      height: 70px;
      fill: #333;
      margin-bottom: 15px;
    }
    .live-empty p { font-size: 14px; line-height: 1.5; }
    
    .live-channel-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #333;
    }
    .live-channel-item:hover { 
      background: linear-gradient(135deg, #252525 0%, #333 100%);
      border-color: #ef4444;
    }
    .live-channel-item:active { 
      transform: scale(0.98);
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
    }
    .live-channel-item.active {
      border-color: #ef4444;
      background: linear-gradient(135deg, #2d1f1f 0%, #3d2525 100%);
    }
    
    .live-channel-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }
    .live-channel-icon svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    .live-channel-icon::after {
      content: '';
      position: absolute;
      inset: -3px;
      border: 2px solid rgba(239, 68, 68, 0.4);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .live-channel-info {
      flex: 1;
      min-width: 0;
    }
    .live-channel-name {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .live-channel-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #888;
    }
    .live-channel-status .live-dot-small {
      width: 6px;
      height: 6px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .live-channel-play {
      width: 40px;
      height: 40px;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .live-channel-play svg {
      width: 20px;
      height: 20px;
      fill: #ef4444;
      margin-left: 2px;
    }
    
    .live-now-playing {
      background: #1f1f1f;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      display: none;
    }
    .live-now-playing.show { display: block; }
    .live-now-playing-label {
      font-size: 10px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }
    .live-now-playing-name {
      font-size: 14px;
      font-weight: 600;
      color: #ef4444;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .live-now-playing-name .live-dot-small {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Live Quality Badge */
    .live-quality {
      position: fixed;
      bottom: 70px;
      right: 15px;
      background: rgba(0,0,0,0.8);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      color: #22c55e;
      font-weight: 600;
      z-index: 55;
      display: none;
    }
    .live-quality.show { display: block; }
    .live-quality.buffering { color: #f59e0b; }
    .live-quality.error { color: #ef4444; }
    
    /* Live controls bar */
    .bottom.live-mode .ctrls {
      margin-top: 8px;
    }
    
    .live-status-bar {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    .bottom.live-mode .live-status-bar { display: flex; }
    
    .live-status-dot {
      width: 10px;
      height: 10px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .live-status-text {
      font-size: 12px;
      color: #ef4444;
      font-weight: 600;
      flex: 1;
    }
    
    .live-quality-text {
      font-size: 11px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div id="player"></div>
    <video id="hlsPlayer" playsinline></video>
    
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <div class="loader-text" id="loaderText">Loading...</div>
    </div>
    
    <div class="ui visible" id="ui">
      <div class="top">
        <button class="nav-btn" id="prevBtn">
          <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="nav-btn" id="nextBtn">
          <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
        <div class="info">
          <div class="video-title" id="vTitle">Loading...</div>
          <div class="video-count" id="vCount">-/-</div>
        </div>
        <button class="nav-btn live-btn" id="liveBtn" title="Live Channels">
          <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
          <span class="live-dot"></span>
        </button>
        <button class="nav-btn search-btn" id="searchBtn" title="Search Videos">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </button>
        <button class="nav-btn history-btn" id="historyBtn" title="Watch History">
          <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
        </button>
        <button class="nav-btn refresh-btn" id="refreshBtn" title="Refresh Playlist">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>
        <button class="nav-btn" id="listBtn">
          <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        </button>
      </div>
      
      <div class="center" id="center">
        <div class="play-big" id="bigPlay">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        <div class="tap-ind left" id="tapL">-10s</div>
        <div class="tap-ind right" id="tapR">+10s</div>
      </div>
      
      <div class="bottom" id="bottomBar">
        <div class="prog-wrap">
          <span class="time" id="curT">0:00</span>
          <div class="prog-bar" id="progBar">
            <div class="prog-track"></div>
            <div class="prog-fill" id="progFill"></div>
            <div class="prog-thumb" id="progThumb"></div>
          </div>
          <span class="time right" id="durT">0:00</span>
        </div>
        <div class="live-status-bar">
          <span class="live-status-dot"></span>
          <span class="live-status-text">LIVE</span>
          <span class="live-quality-text" id="liveQuality"></span>
        </div>
        <div class="ctrls">
          <div class="ctrl-grp">
            <button class="ctrl-btn" id="playBtn">
              <svg id="icPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              <svg id="icPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="ctrl-btn" id="muteBtn">
              <svg id="icVol" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
              <svg id="icMute" viewBox="0 0 24 24" style="display:none"><path d="M16.5 12A4.5 4.5 0 0014 7.97v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.8 8.8 0 0021 12c0-4.28-3-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.26c-.67.52-1.42.93-2.25 1.18v2.06a9 9 0 003.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
            </button>
          </div>
          <div class="ctrl-grp">
            <button class="ctrl-btn spd" id="spdBtn">1x</button>
            <button class="ctrl-btn on" id="autoBtn">
              <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
            <button class="ctrl-btn" id="fsBtn">
              <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="drawer-bg" id="drawerBg"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-head">
      <h3>Playlist (<span id="plCount">0</span>)</h3>
      <button class="nav-btn" id="closeDrawer">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="drawer-list" id="drawerList"></div>
  </div>
  
  <!-- Search Modal -->
  <div class="search-modal" id="searchModal">
    <div class="search-header">
      <div class="search-input-wrap">
        <input type="text" class="search-input" id="searchInput" placeholder="Search videos from channels..." autocomplete="off">
        <button class="search-submit" id="searchSubmit">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </button>
      </div>
      <button class="search-close" id="searchClose">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="search-history" id="searchHistorySection" style="display:none;">
      <div class="search-history-title">
        <span>Recent Searches</span>
        <button id="clearSearchHistory">Clear</button>
      </div>
      <div class="search-history-chips" id="searchHistoryChips"></div>
    </div>
    <div class="search-info">Searching in <span id="channelCount">0</span> channels from Column C</div>
    <div class="search-results" id="searchResults">
      <div class="search-empty">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <p>Enter a search term to find videos<br>from your channels</p>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div class="history-modal" id="historyModal">
    <div class="history-header">
      <h3>
        <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
        Watch History
      </h3>
      <div class="history-header-actions">
        <button class="history-clear" id="clearHistory">Clear All</button>
        <button class="search-close" id="historyClose">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
    </div>
    <div class="history-content" id="historyContent">
      <div class="history-empty">
        <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
        <p>No watch history yet.<br>Videos you play from search will appear here.</p>
      </div>
    </div>
  </div>
  
  <!-- Live Channels Modal -->
  <div class="live-modal" id="liveModal">
    <div class="live-header">
      <h3>
        <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
        Live Channels
        <span class="live-badge">LIVE</span>
      </h3>
      <button class="search-close" id="liveClose">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="live-content" id="liveContent">
      <div class="live-now-playing" id="liveNowPlaying">
        <div class="live-now-playing-label">Now Playing</div>
        <div class="live-now-playing-name">
          <span class="live-dot-small"></span>
          <span id="liveNowPlayingName">-</span>
        </div>
      </div>
      <div class="live-empty" id="liveEmpty">
        <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
        <p>No live channels found.<br>Add channel names to Column D and m3u8 links to Column E.</p>
      </div>
      <div id="liveChannelsList"></div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  <div class="status" id="status"></div>
  
  <div class="install-bar hide" id="installBar">
    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
    <span>Install App</span>
    <button class="i-btn" id="installBtn">Install</button>
    <button class="i-close" id="closeInstall">
      <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SHEET_ID = "18vr3vEXz378zaDwWZFcIDTZ1J5xzQ0vfZQ5KjjhhXVg";
    const AUTO_REFRESH_INTERVAL = 15000;
    
    // ===== YOUTUBE API KEY =====
    const YOUTUBE_API_KEY = "AIzaSyCKw3OZQ-hKWgh7hXds4M53ToleyX6g9CE";
    
    // ===== STATE =====
    let player = null;
    let hls = null;
    let hlsPlayer = null;
    let videos = [];
    let liveChannels = [];
    let currentLiveChannel = null;
    let isLiveMode = false;
    let idx = 0;
    let playing = false;
    let dur = 0;
    let muted = false;
    let autoNext = true;
    let speed = 1;
    let hideT = null;
    let updT = null;
    let ready = false;
    let lastDataHash = '';
    let titleCache = {};
    let isSeeking = false;
    let channelIds = [];
    let isSearching = false;
    let searchHistory = [];
    let watchHistory = [];
    
    // Load history from localStorage on startup
    function loadHistoryFromStorage() {
      try {
        const savedSearchHistory = localStorage.getItem('vp_search_history');
        if (savedSearchHistory) {
          searchHistory = JSON.parse(savedSearchHistory);
        }
        const savedWatchHistory = localStorage.getItem('vp_watch_history');
        if (savedWatchHistory) {
          watchHistory = JSON.parse(savedWatchHistory);
        }
        console.log('[HISTORY] Loaded', searchHistory.length, 'search items and', watchHistory.length, 'watch items');
      } catch(e) {
        console.error('[HISTORY] Failed to load from storage:', e);
        searchHistory = [];
        watchHistory = [];
      }
    }
    
    function saveSearchHistory() {
      try {
        localStorage.setItem('vp_search_history', JSON.stringify(searchHistory.slice(0, 10)));
      } catch(e) {
        console.error('[HISTORY] Failed to save search history:', e);
      }
    }
    
    function saveWatchHistory() {
      try {
        localStorage.setItem('vp_watch_history', JSON.stringify(watchHistory.slice(0, 50)));
      } catch(e) {
        console.error('[HISTORY] Failed to save watch history:', e);
      }
    }
    
    // ===== HELPERS =====
    const $ = id => document.getElementById(id);
    const loader = $('loader');
    const loaderText = $('loaderText');
    const ui = $('ui');
    const vTitle = $('vTitle');
    const vCount = $('vCount');
    const curT = $('curT');
    const durT = $('durT');
    const progBar = $('progBar');
    const progFill = $('progFill');
    const progThumb = $('progThumb');
    const icPlay = $('icPlay');
    const icPause = $('icPause');
    const icVol = $('icVol');
    const icMute = $('icMute');
    const bigPlay = $('bigPlay');
    const center = $('center');
    const tapL = $('tapL');
    const tapR = $('tapR');
    const drawer = $('drawer');
    const drawerBg = $('drawerBg');
    const drawerList = $('drawerList');
    const toast = $('toast');
    const status = $('status');
    const refreshBtn = $('refreshBtn');
    const searchModal = $('searchModal');
    const searchInput = $('searchInput');
    const searchResults = $('searchResults');
    const historyModal = $('historyModal');
    const historyContent = $('historyContent');
    const searchHistorySection = $('searchHistorySection');
    const searchHistoryChips = $('searchHistoryChips');
    const liveModal = $('liveModal');
    const liveContent = $('liveContent');
    const bottomBar = $('bottomBar');
    
    hlsPlayer = $('hlsPlayer');
    
    function fmt(s) {
      if (!s || isNaN(s)) return '0:00';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }
    
    function fmtDuration(iso) {
      if (!iso) return '';
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return '';
      const h = parseInt(match[1] || 0);
      const m = parseInt(match[2] || 0);
      const s = parseInt(match[3] || 0);
      if (h > 0) return h + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      return m + ':' + String(s).padStart(2,'0');
    }
    
    function fmtViews(n) {
      if (!n) return '';
      n = parseInt(n);
      if (n >= 1000000) return (n/1000000).toFixed(1) + 'M views';
      if (n >= 1000) return (n/1000).toFixed(1) + 'K views';
      return n + ' views';
    }
    
    function msg(t, duration = 2000) {
      toast.textContent = t;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }
    
    function showStatus(text, type = '') {
      status.textContent = text;
      status.className = 'status show ' + type;
      setTimeout(() => status.classList.remove('show'), 2000);
    }
    
    function getVid(url) {
      if (!url) return null;
      url = url.trim();
      let match = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
      if (match) return match[1];
      match = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
      if (match) return match[1];
      match = url.match(/embed\/([a-zA-Z0-9_-]{11})/);
      if (match) return match[1];
      match = url.match(/^([a-zA-Z0-9_-]{11})$/);
      if (match) return match[1];
      return null;
    }
    function extractChannelId(url) {
      if (!url) return null;
      url = url.trim();
      
      let match = url.match(/^(UC[a-zA-Z0-9_-]{22})$/);
      if (match) return match[1];
      
      match = url.match(/youtube\.com\/channel\/(UC[a-zA-Z0-9_-]{22})/);
      if (match) return match[1];
      
      match = url.match(/youtube\.com\/@([a-zA-Z0-9_-]+)/);
      if (match) return { type: 'handle', value: match[1] };
      
      match = url.match(/youtube\.com\/c\/([a-zA-Z0-9_-]+)/);
      if (match) return { type: 'custom', value: match[1] };
      
      match = url.match(/youtube\.com\/user\/([a-zA-Z0-9_-]+)/);
      if (match) return { type: 'user', value: match[1] };
      
      return null;
    }
    
    function hashCode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString();
    }
    
    // ===== UI VISIBILITY =====
    function showUI() {
      ui.classList.add('visible');
      clearTimeout(hideT);
    }
    
    function hideUI() {
      if (playing && !isSeeking) ui.classList.remove('visible');
    }
    
    function autoHide() {
      clearTimeout(hideT);
      if (playing && !isSeeking) hideT = setTimeout(hideUI, 3000);
    }
    
    function setPlayState(isPlay) {
      playing = isPlay;
      if (isPlay) {
        icPlay.style.display = 'none';
        icPause.style.display = 'block';
        bigPlay.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        autoHide();
      } else {
        icPlay.style.display = 'block';
        icPause.style.display = 'none';
        bigPlay.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
        showUI();
      }
    }
    
    // ===== PROGRESS =====
    function startUpd() {
      stopUpd();
      upd();
      updT = setInterval(upd, 500);
    }
    
    function stopUpd() {
      if (updT) { clearInterval(updT); updT = null; }
    }
    
    function upd() {
      if (isSeeking) return;
      
      if (isLiveMode) {
        // Live mode - no progress bar needed
        return;
      }
      
      if (!player || !ready) return;
      try {
        const c = player.getCurrentTime() || 0;
        dur = player.getDuration() || dur;
        const p = dur > 0 ? (c / dur) * 100 : 0;
        progFill.style.width = p + '%';
        progThumb.style.left = p + '%';
        curT.textContent = fmt(c);
        durT.textContent = fmt(dur);
      } catch(e) {}
    }
    
    // ===== FETCH SHEET DATA =====
    async function fetchSheetData() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=link&_=${Date.now()}`;
      
      console.log('[FETCH] Getting sheet data...');
      
      const response = await fetch(url, { method: 'GET', cache: 'no-store' });
      
      if (!response.ok) throw new Error('Failed to fetch: ' + response.status);
      
      const text = await response.text();
      const jsonStart = text.indexOf('({');
      const jsonEnd = text.lastIndexOf('})');
      if (jsonStart === -1 || jsonEnd === -1) throw new Error('Invalid response format');
      
      const jsonStr = text.substring(jsonStart + 1, jsonEnd + 1);
      const data = JSON.parse(jsonStr);
      
      const newVideos = [];
      const newChannels = [];
      const newLiveChannels = [];
      const seenChannels = new Set();
      
      if (data.table && data.table.rows) {
        for (const row of data.table.rows) {
          if (row.c) {
            const titleCell = row.c[0];        // Column A - Video title
            const urlCell = row.c[1];           // Column B - YouTube URL
            const channelCell = row.c[2];       // Column C - Channel IDs for search
            const liveNameCell = row.c[3];      // Column D - Live channel name
            const liveUrlCell = row.c[4];       // Column E - m3u8 link
            
            // Extract video from Column B
            let url = '';
            if (urlCell && urlCell.v) {
              url = String(urlCell.v).trim();
            }
            
            const videoId = getVid(url);
            if (videoId) {
              let title = '';
              if (titleCell && titleCell.v) {
                title = String(titleCell.v).trim();
              }
              if (!title && titleCache[videoId]) {
                title = titleCache[videoId];
              }
              newVideos.push({ id: videoId, title: title || '', url: url });
            }
            
            // Extract channel from Column C
            if (channelCell && channelCell.v) {
              const channelUrl = String(channelCell.v).trim();
              if (channelUrl && !seenChannels.has(channelUrl)) {
                seenChannels.add(channelUrl);
                const channelInfo = extractChannelId(channelUrl);
                if (channelInfo) {
                  newChannels.push(channelInfo);
                }
              }
            }
            
            // Extract live channel from Column D and E
            if (liveNameCell && liveNameCell.v && liveUrlCell && liveUrlCell.v) {
              const liveName = String(liveNameCell.v).trim();
              const liveUrl = String(liveUrlCell.v).trim();
              if (liveName && liveUrl && (liveUrl.includes('.m3u8') || liveUrl.includes('m3u8'))) {
                newLiveChannels.push({ name: liveName, url: liveUrl });
              }
            }
          }
        }
      }
      
      channelIds = newChannels;
      liveChannels = newLiveChannels;
      $('channelCount').textContent = channelIds.length;
      
      console.log('[FETCH] Found', newVideos.length, 'videos,', channelIds.length, 'channels, and', liveChannels.length, 'live channels');
      return newVideos;
    }
    
    // ===== RESOLVE CHANNEL TO ID =====
    async function resolveChannelToId(channelInfo) {
      if (typeof channelInfo === 'string') return channelInfo;
      
      if (YOUTUBE_API_KEY === "YOUR_API_KEY_HERE") {
        console.log('[CHANNEL] API key not set, cannot resolve channel');
        return null;
      }
      
      try {
        let apiUrl = '';
        if (channelInfo.type === 'handle') {
          apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${channelInfo.value}&key=${YOUTUBE_API_KEY}`;
        } else if (channelInfo.type === 'user') {
          apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=id&forUsername=${channelInfo.value}&key=${YOUTUBE_API_KEY}`;
        } else if (channelInfo.type === 'custom') {
          apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(channelInfo.value)}&maxResults=1&key=${YOUTUBE_API_KEY}`;
        }
        
        if (!apiUrl) return null;
        
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (data.error) {
          console.error('[CHANNEL] API error:', data.error.message);
          return null;
        }
        
        if (channelInfo.type === 'custom' && data.items && data.items[0]) {
          return data.items[0].snippet.channelId;
        } else if (data.items && data.items[0]) {
          return data.items[0].id;
        }
      } catch (e) {
        console.error('[CHANNEL] Error resolving:', e);
      }
      
      return null;
    }
    
    // ===== SEARCH VIDEOS =====
    async function searchVideosInChannels(query) {
      if (YOUTUBE_API_KEY === "YOUR_API_KEY_HERE") {
        msg('Please add your YouTube API key!');
        return [];
      }
      
      if (!query.trim()) return [];
      
      if (channelIds.length === 0) {
        msg('No channels found in Column C');
        return [];
      }
      
      const allResults = [];
      
      const resolvedIds = [];
      for (const ch of channelIds) {
        const resolved = await resolveChannelToId(ch);
        if (resolved) resolvedIds.push(resolved);
      }
      
      console.log('[SEARCH] Searching in', resolvedIds.length, 'resolved channels');
      
      for (const channelId of resolvedIds) {
        try {
          const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&q=${encodeURIComponent(query)}&type=video&maxResults=5&order=relevance&key=${YOUTUBE_API_KEY}`;
          
          const res = await fetch(searchUrl);
          const data = await res.json();
          
          if (data.error) {
            console.error('[SEARCH] API Error:', data.error.message);
            if (data.error.code === 403) {
              msg('API quota exceeded or key invalid');
              return allResults;
            }
            continue;
          }
          
          if (data.items) {
            for (const item of data.items) {
              allResults.push({
                id: item.id.videoId,
                title: item.snippet.title,
                channel: item.snippet.channelTitle,
                thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                publishedAt: item.snippet.publishedAt
              });
            }
          }
        } catch (e) {
          console.error('[SEARCH] Error:', e);
        }
      }
      
      if (allResults.length > 0) {
        try {
          const videoIds = allResults.map(r => r.id).join(',');
          const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
          
          const res = await fetch(detailsUrl);
          const data = await res.json();
          
          if (data.items) {
            for (const item of data.items) {
              const result = allResults.find(r => r.id === item.id);
              if (result) {
                result.duration = fmtDuration(item.contentDetails.duration);
                result.views = fmtViews(item.statistics.viewCount);
              }
            }
          }
        } catch (e) {
          console.log('[SEARCH] Failed to get details:', e);
        }
      }
      
      const unique = [];
      const seen = new Set();
      for (const r of allResults) {
        if (!seen.has(r.id)) {
          seen.add(r.id);
          unique.push(r);
        }
      }
      
      return unique;
    }
    
    function renderSearchResults(results, query) {
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="search-empty">
            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <p>No videos found for "${query}"</p>
          </div>
        `;
        return;
      }
      
      searchResults.innerHTML = results.map(r => `
        <div class="search-result-item" data-id="${r.id}" data-title="${r.title.replace(/"/g, '&quot;')}">
          <div class="search-thumb">
            <img src="${r.thumbnail}" alt="" loading="lazy" onerror="this.style.display='none'">
            ${r.duration ? `<span class="duration">${r.duration}</span>` : ''}
          </div>
          <div class="search-result-info">
            <div class="search-result-title">${r.title}</div>
            <div class="search-result-channel">${r.channel}</div>
            <div class="search-result-meta">${r.views || ''}</div>
          </div>
        </div>
      `).join('');
    }
    
    function addToSearchHistory(query) {
      query = query.trim();
      if (!query) return;
      searchHistory = searchHistory.filter(q => q.toLowerCase() !== query.toLowerCase());
      searchHistory.unshift(query);
      if (searchHistory.length > 10) searchHistory = searchHistory.slice(0, 10);
      saveSearchHistory();
      renderSearchHistory();
    }
    
    function addToWatchHistory(video) {
      watchHistory = watchHistory.filter(v => v.id !== video.id);
      watchHistory.unshift({
        ...video,
        watchedAt: Date.now()
      });
      if (watchHistory.length > 50) watchHistory = watchHistory.slice(0, 50);
      saveWatchHistory();
      console.log('[HISTORY] Added to watch history:', video.title, '- Total:', watchHistory.length);
    }
    
    function renderSearchHistory() {
      if (searchHistory.length === 0) {
        searchHistorySection.style.display = 'none';
        return;
      }
      searchHistorySection.style.display = 'block';
      searchHistoryChips.innerHTML = searchHistory.map(q => `
        <div class="search-chip" data-query="${q.replace(/"/g, '&quot;')}">
          <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
          ${q}
        </div>
      `).join('');
    }
    
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';
      const days = Math.floor(hours / 24);
      if (days < 7) return days + 'd ago';
      const weeks = Math.floor(days / 7);
      return weeks + 'w ago';
    }
    
    function renderWatchHistory() {
      if (watchHistory.length === 0) {
        historyContent.innerHTML = `
          <div class="history-empty">
            <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            <p>No watch history yet.<br>Videos you play from search will appear here.</p>
          </div>
        `;
        return;
      }
      
      historyContent.innerHTML = watchHistory.map((v, i) => `
        <div class="history-item" data-id="${v.id}" data-title="${v.title.replace(/"/g, '&quot;')}" data-index="${i}">
          <div class="history-item-thumb">
            <img src="${v.thumbnail}" alt="" loading="lazy" onerror="this.style.display='none'">
            ${v.duration ? `<span class="duration">${v.duration}</span>` : ''}
          </div>
          <div class="history-item-info">
            <div class="history-item-title">${v.title}</div>
            <div class="history-item-channel">${v.channel || ''}</div>
            <div class="history-item-time">${formatTimeAgo(v.watchedAt)}</div>
          </div>
          <button class="history-item-delete" data-delete="${i}">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </div>
      `).join('');
    }
    
    // ===== LIVE CHANNELS =====
    function renderLiveChannels() {
      const listEl = $('liveChannelsList');
      const emptyEl = $('liveEmpty');
      const nowPlayingEl = $('liveNowPlaying');
      
      if (liveChannels.length === 0) {
        emptyEl.style.display = 'block';
        listEl.innerHTML = '';
        nowPlayingEl.classList.remove('show');
        return;
      }
      
      emptyEl.style.display = 'none';
      
      // Show now playing if in live mode
      if (isLiveMode && currentLiveChannel) {
        nowPlayingEl.classList.add('show');
        $('liveNowPlayingName').textContent = currentLiveChannel.name;
      } else {
        nowPlayingEl.classList.remove('show');
      }
      
      listEl.innerHTML = liveChannels.map((ch, i) => `
        <div class="live-channel-item${currentLiveChannel && currentLiveChannel.url === ch.url ? ' active' : ''}" data-index="${i}">
          <div class="live-channel-icon">
            <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
          </div>
          <div class="live-channel-info">
            <div class="live-channel-name">${ch.name}</div>
            <div class="live-channel-status">
              <span class="live-dot-small"></span>
              <span>Live Stream</span>
            </div>
          </div>
          <div class="live-channel-play">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          </div>
        </div>
      `).join('');
    }
    
    function playLiveChannel(channel) {
      console.log('[LIVE] Playing:', channel.name, channel.url);
      
      // Stop YouTube player if playing
      if (player && ready) {
        try { player.pauseVideo(); } catch(e) {}
      }
      
      // Destroy existing HLS instance
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      // Set live mode
      isLiveMode = true;
      currentLiveChannel = channel;
      
      // Update UI for live mode
      vTitle.textContent = channel.name;
      vCount.textContent = ' LIVE';
      vCount.classList.add('live-indicator');
      bottomBar.classList.add('live-mode');
      
      // Hide YouTube player, show HLS player
      $('player').style.display = 'none';
      hlsPlayer.classList.add('active');
      
      // Show loader with connection stages
      loaderText.textContent = 'Connecting...';
      loader.classList.remove('hide');
      
      // Update loader text progressively
      setTimeout(() => {
        if (loader.classList.contains('hide')) return;
        loaderText.textContent = 'Loading stream data...';
      }, 1000);
      
      setTimeout(() => {
        if (loader.classList.contains('hide')) return;
        loaderText.textContent = 'Buffering...';
      }, 3000);
      
      // Initialize HLS with optimized settings for fast startup and smooth playback
      if (Hls.isSupported()) {
        hls = new Hls({
          // Performance & Speed
          enableWorker: true,
          lowLatencyMode: false, // Disable for stability
          
          // Buffer settings - smaller for faster start
          maxBufferLength: 10,           // Max buffer in seconds (faster start)
          maxMaxBufferLength: 30,        // Max buffer cap
          maxBufferSize: 60 * 1000 * 1000, // 60MB max buffer
          maxBufferHole: 0.5,            // Max gap to skip
          
          // Live sync settings
          liveSyncDurationCount: 3,      // Segments behind live edge
          liveMaxLatencyDurationCount: 10, // Max latency before sync
          liveDurationInfinity: true,    // Infinite duration for live
          liveBackBufferLength: 30,      // Back buffer for live
          
          // Faster fragment loading
          fragLoadingTimeOut: 20000,     // 20s timeout
          fragLoadingMaxRetry: 6,        // More retries
          fragLoadingRetryDelay: 500,    // Fast retry
          fragLoadingMaxRetryTimeout: 64000,
          
          // Faster manifest loading
          manifestLoadingTimeOut: 10000,
          manifestLoadingMaxRetry: 4,
          manifestLoadingRetryDelay: 500,
          manifestLoadingMaxRetryTimeout: 64000,
          
          // Level loading
          levelLoadingTimeOut: 10000,
          levelLoadingMaxRetry: 4,
          levelLoadingRetryDelay: 500,
          levelLoadingMaxRetryTimeout: 64000,
          
          // Start settings
          startLevel: -1,                // Auto select best quality
          startFragPrefetch: true,       // Prefetch first fragment
          testBandwidth: true,
          
          // ABR settings for smooth quality switching
          abrEwmaDefaultEstimate: 500000,  // Initial bandwidth estimate
          abrBandWidthFactor: 0.95,
          abrBandWidthUpFactor: 0.7,
          abrMaxWithRealBitrate: true,
          
          // Stall recovery
          highBufferWatchdogPeriod: 2,
          nudgeOffset: 0.1,
          nudgeMaxRetry: 5,
          
          // XHR settings
          xhrSetup: function(xhr, url) {
            xhr.withCredentials = false;
          }
        });
        
        hls.loadSource(channel.url);
        hls.attachMedia(hlsPlayer);
        
        // Track loading progress
        let manifestLoaded = false;
        let firstFragLoaded = false;
        
        hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
          console.log('[HLS] Manifest loaded, levels:', data.levels.length);
          manifestLoaded = true;
          loaderText.textContent = 'Buffering stream...';
        });
        
        hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
          if (!firstFragLoaded) {
            firstFragLoaded = true;
            console.log('[HLS] First fragment loaded');
          }
        });
        
        hls.on(Hls.Events.FRAG_BUFFERED, function(event, data) {
          // Start playback as soon as we have buffered data
          if (hlsPlayer.paused && hlsPlayer.readyState >= 3) {
            loader.classList.add('hide');
            hlsPlayer.play().catch(e => {
              console.log('[HLS] Autoplay blocked:', e);
              setPlayState(false);
              loader.classList.add('hide');
            });
          }
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
          console.error('[HLS] Error:', data.type, data.details);
          
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.log('[HLS] Network error, attempting recovery...');
                loaderText.textContent = 'Connection lost, retrying...';
                loader.classList.remove('hide');
                // Try to recover
                setTimeout(() => {
                  if (hls) {
                    hls.startLoad();
                  }
                }, 1000);
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.log('[HLS] Media error, attempting recovery...');
                hls.recoverMediaError();
                break;
              default:
                msg('Stream error: ' + data.details);
                stopLiveChannel();
                break;
            }
          } else {
            // Non-fatal errors - just log
            if (data.details === 'bufferStalledError') {
              loaderText.textContent = 'Buffering...';
              loader.classList.remove('hide');
            }
          }
        });
        
        // Level switching for quality info
        hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
          const level = hls.levels[data.level];
          if (level) {
            const quality = level.height ? level.height + 'p' : Math.round(level.bitrate/1000) + 'kbps';
            console.log('[HLS] Quality:', quality);
            const qualityEl = $('liveQuality');
            if (qualityEl) {
              qualityEl.textContent = quality;
            }
          }
        });
        
      } else if (hlsPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        // For Safari native HLS support
        hlsPlayer.src = channel.url;
        hlsPlayer.addEventListener('loadedmetadata', function() {
          loader.classList.add('hide');
          hlsPlayer.play();
        });
      } else {
        msg('HLS playback not supported');
        stopLiveChannel();
        return;
      }
      
      closeLive();
      showUI();
      autoHide();
    }
    
    function stopLiveChannel() {
      // Stop stall detection
      stopStallDetection();
      
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      hlsPlayer.pause();
      hlsPlayer.removeAttribute('src');
      hlsPlayer.load(); // Reset the player
      hlsPlayer.classList.remove('active');
      
      isLiveMode = false;
      currentLiveChannel = null;
      
      // Restore UI
      vCount.classList.remove('live-indicator');
      bottomBar.classList.remove('live-mode');
      $('player').style.display = 'block';
      
      // Restore YouTube player state
      if (videos.length > 0) {
        updTitle();
      }
    }
    
    // HLS player events with stall recovery
    let stallCheckInterval = null;
    let lastPlaybackTime = 0;
    let stallCount = 0;
    
    function startStallDetection() {
      stopStallDetection();
      lastPlaybackTime = hlsPlayer.currentTime;
      stallCount = 0;
      
      stallCheckInterval = setInterval(() => {
        if (!isLiveMode || hlsPlayer.paused) return;
        
        const currentTime = hlsPlayer.currentTime;
        
        // If time hasn't progressed and we're supposed to be playing
        if (currentTime === lastPlaybackTime && !hlsPlayer.paused && !hlsPlayer.ended) {
          stallCount++;
          console.log('[HLS] Stall detected, count:', stallCount);
          
          if (stallCount >= 3) {
            // Try recovery
            console.log('[HLS] Attempting stall recovery...');
            loaderText.textContent = 'Recovering stream...';
            loader.classList.remove('hide');
            
            if (hls) {
              // Try seeking slightly forward
              hlsPlayer.currentTime = currentTime + 0.1;
              
              if (stallCount >= 6) {
                // More aggressive recovery
                hls.recoverMediaError();
                stallCount = 0;
              }
            }
          }
        } else {
          stallCount = 0;
        }
        
        lastPlaybackTime = currentTime;
      }, 1000);
    }
    
    function stopStallDetection() {
      if (stallCheckInterval) {
        clearInterval(stallCheckInterval);
        stallCheckInterval = null;
      }
    }
    
    hlsPlayer.onplay = () => {
      setPlayState(true);
      startStallDetection();
    };
    
    hlsPlayer.onpause = () => {
      setPlayState(false);
      stopStallDetection();
    };
    
    hlsPlayer.onwaiting = () => {
      loaderText.textContent = 'Buffering...';
      loader.classList.remove('hide');
    };
    
    hlsPlayer.onplaying = () => {
      loader.classList.add('hide');
      stallCount = 0;
    };
    
    hlsPlayer.oncanplay = () => {
      console.log('[HLS] Can play');
    };
    
    hlsPlayer.oncanplaythrough = () => {
      console.log('[HLS] Can play through');
      loader.classList.add('hide');
    };
    
    hlsPlayer.onstalled = () => {
      console.log('[HLS] Playback stalled');
      loaderText.textContent = 'Stream stalled...';
      loader.classList.remove('hide');
    };
    
    hlsPlayer.onerror = (e) => {
      console.error('[HLS] Player error:', e);
      // Try recovery before showing error
      if (hls && isLiveMode) {
        console.log('[HLS] Attempting error recovery...');
        hls.recoverMediaError();
      } else {
        msg('Playback error');
      }
    };
    
    // ===== SEARCH UI =====
    function openSearch() {
      searchModal.classList.add('open');
      searchInput.focus();
      renderSearchHistory();
      if (player && playing) player.pauseVideo();
      if (isLiveMode) hlsPlayer.pause();
    }
    
    function closeSearch() {
      searchModal.classList.remove('open');
      searchInput.value = '';
      searchResults.innerHTML = `
        <div class="search-empty">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <p>Enter a search term to find videos<br>from your channels</p>
        </div>
      `;
    }
    
    // ===== HISTORY UI =====
    function openHistory() {
      historyModal.classList.add('open');
      renderWatchHistory();
      if (player && playing) player.pauseVideo();
      if (isLiveMode) hlsPlayer.pause();
    }
    
    function closeHistory() {
      historyModal.classList.remove('open');
    }
    
    // ===== LIVE UI =====
    function openLive() {
      liveModal.classList.add('open');
      renderLiveChannels();
      if (player && playing && !isLiveMode) player.pauseVideo();
    }
    
    function closeLive() {
      liveModal.classList.remove('open');
    }
    
    async function performSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        msg('Enter a search term');
        return;
      }
      
      if (isSearching) return;
      isSearching = true;
      
      addToSearchHistory(query);
      
      searchResults.innerHTML = `
        <div class="search-loading">
          <div class="spinner"></div>
          <p>Searching ${channelIds.length} channels...</p>
        </div>
      `;
      
      try {
        const results = await searchVideosInChannels(query);
        renderSearchResults(results, query);
      } catch (e) {
        console.error('[SEARCH] Error:', e);
        searchResults.innerHTML = `
          <div class="search-empty">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            <p>Search failed. Please try again.</p>
          </div>
        `;
      }
      
      isSearching = false;
    }
    
    // Search result click
    searchResults.onclick = e => {
      const item = e.target.closest('.search-result-item');
      if (item) {
        const videoId = item.dataset.id;
        const videoTitle = item.dataset.title;
        const thumbnail = item.querySelector('.search-thumb img')?.src || '';
        const duration = item.querySelector('.search-thumb .duration')?.textContent || '';
        const channel = item.querySelector('.search-result-channel')?.textContent || '';
        
        addToWatchHistory({
          id: videoId,
          title: videoTitle,
          thumbnail: thumbnail,
          duration: duration,
          channel: channel
        });
        
        closeSearch();
        
        // Stop live mode if active
        if (isLiveMode) {
          stopLiveChannel();
        }
        
        if (player && ready) {
          loaderText.textContent = 'Loading...';
          loader.classList.remove('hide');
          vTitle.textContent = videoTitle;
          vCount.textContent = 'Search Result';
          player.loadVideoById({ videoId: videoId, suggestedQuality: 'default' });
          msg('Playing: ' + videoTitle);
        }
      }
    };
    
    // Search history chip click
    searchHistoryChips.onclick = e => {
      const chip = e.target.closest('.search-chip');
      if (chip) {
        const query = chip.dataset.query;
        searchInput.value = query;
        performSearch();
      }
    };
    
    // Clear search history
    $('clearSearchHistory').onclick = e => {
      e.stopPropagation();
      searchHistory = [];
      saveSearchHistory();
      renderSearchHistory();
      msg('Search history cleared');
    };
    
    // History item click
    historyContent.onclick = e => {
      const deleteBtn = e.target.closest('.history-item-delete');
      if (deleteBtn) {
        e.stopPropagation();
        const index = parseInt(deleteBtn.dataset.delete);
        watchHistory.splice(index, 1);
        saveWatchHistory();
        renderWatchHistory();
        msg('Removed from history');
        return;
      }
      
      const item = e.target.closest('.history-item');
      if (item) {
        const videoId = item.dataset.id;
        const videoTitle = item.dataset.title;
        
        const index = parseInt(item.dataset.index);
        const video = watchHistory[index];
        watchHistory.splice(index, 1);
        video.watchedAt = Date.now();
        watchHistory.unshift(video);
        saveWatchHistory();
        
        closeHistory();
        
        // Stop live mode if active
        if (isLiveMode) {
          stopLiveChannel();
        }
        
        if (player && ready) {
          loaderText.textContent = 'Loading...';
          loader.classList.remove('hide');
          vTitle.textContent = videoTitle;
          vCount.textContent = 'From History';
          player.loadVideoById({ videoId: videoId, suggestedQuality: 'default' });
          msg('Playing: ' + videoTitle);
        }
      }
    };
    
    // Clear all watch history
    $('clearHistory').onclick = e => {
      e.stopPropagation();
      if (confirm('Clear all watch history?')) {
        watchHistory = [];
        saveWatchHistory();
        renderWatchHistory();
        msg('Watch history cleared');
      }
    };
    
    // Live channel click
    $('liveChannelsList').onclick = e => {
      const item = e.target.closest('.live-channel-item');
      if (item) {
        const index = parseInt(item.dataset.index);
        const channel = liveChannels[index];
        if (channel) {
          playLiveChannel(channel);
        }
      }
    };
    
    // ===== FETCH YOUTUBE TITLES =====
    async function fetchYouTubeTitle(videoId) {
      if (titleCache[videoId]) return titleCache[videoId];
      
      try {
        const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
        const data = await response.json();
        if (data.title) {
          titleCache[videoId] = data.title;
          return data.title;
        }
      } catch (e) {}
      
      try {
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        const data = await response.json();
        if (data.title) {
          titleCache[videoId] = data.title;
          return data.title;
        }
      } catch (e) {}
      
      return null;
    }
    
    async function fetchAllTitles() {
      for (let i = 0; i < videos.length; i++) {
        const video = videos[i];
        if (video.title && !video.title.match(/^Video \d+$/)) continue;
        
        const title = await fetchYouTubeTitle(video.id);
        if (title) {
          videos[i].title = title;
          if (i === idx && !isLiveMode) vTitle.textContent = title;
          const item = drawerList.querySelector(`[data-i="${i}"] .name`);
          if (item) {
            item.textContent = title;
            item.classList.remove('loading');
          }
        } else {
          videos[i].title = 'Video ' + (i + 1);
        }
        await new Promise(r => setTimeout(r, 200));
      }
    }
    
    // ===== LOAD DATA =====
    async function loadData(showLoader = true) {
      try {
        if (showLoader) {
          loaderText.textContent = 'Loading playlist...';
          loader.classList.remove('hide');
        }
        
        const newVideos = await fetchSheetData();
        
        if (!newVideos.length && liveChannels.length === 0) {
          showErr('No videos or live channels found in sheet');
          return false;
  }
        const newHash = hashCode(JSON.stringify(newVideos.map(v => v.id)));
        const dataChanged = newHash !== lastDataHash;
        lastDataHash = newHash;
        
        if (dataChanged || videos.length === 0) {
          const currentId = videos[idx]?.id;
          videos = newVideos;
          
          if (currentId) {
            const newIdx = videos.findIndex(v => v.id === currentId);
            if (newIdx >= 0) idx = newIdx;
            else idx = Math.min(idx, videos.length - 1);
          }
          
          if (showLoader) {
            try {
              const s = localStorage.getItem('vp_idx');
              if (s) idx = Math.min(parseInt(s) || 0, videos.length - 1);
            } catch(e) {}
          }
          
          videos.forEach((v, i) => { if (!v.title) v.title = 'Loading...'; });
          
          renderList();
          if (!isLiveMode) updTitle();
          $('plCount').textContent = videos.length;
          
          fetchAllTitles();
          
          if (!showLoader) msg('Playlist updated! (' + videos.length + ' videos, ' + liveChannels.length + ' live)');
          
          return true;
        }
        
        return false;
      } catch(e) {
        console.error('[DATA] Error:', e);
        if (showLoader) showErr('Failed to load: ' + e.message);
        else showStatus('Sync failed', 'error');
        return false;
      }
    }
    
    function showErr(m) {
      loader.innerHTML = `<div class="err-box"><p>${m}</p><button onclick="location.reload()">Retry</button></div>`;
    }
    
    function renderList() {
      drawerList.innerHTML = videos.map((v, i) => {
        const isLoading = v.title === 'Loading...' || !v.title;
        return `<div class="pl-item${i === idx ? ' active' : ''}" data-i="${i}">
          <span class="num">${i + 1}</span>
          <span class="name${isLoading ? ' loading' : ''}">${v.title || 'Loading...'}</span>
        </div>`;
      }).join('');
    }
    
    // ===== PLAYER =====
    function loadAPI() {
      if (window.YT && window.YT.Player) { createPlayer(); return; }
      const s = document.createElement('script');
      s.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(s);
    }
    
    window.onYouTubeIframeAPIReady = function() {
      if (videos.length) createPlayer();
    };
    
    function createPlayer() {
      const v = videos[idx];
      if (!v) return;
      
      updTitle();
      
      player = new YT.Player('player', {
        videoId: v.id,
        playerVars: {
          autoplay: 1, controls: 0, disablekb: 1, enablejsapi: 1, fs: 0,
          iv_load_policy: 3, modestbranding: 1, playsinline: 1, rel: 0,
          showinfo: 0, cc_load_policy: 0, origin: location.origin
        },
        events: { onReady: onReady, onStateChange: onState, onError: onErr }
      });
    }
    
    function onReady() {
      ready = true;
      loader.classList.add('hide');
      dur = player.getDuration() || 0;
      durT.textContent = fmt(dur);
      player.setPlaybackRate(speed);
      showUI();
      autoHide();
      startUpd();
      player.playVideo();
    }
    
    function onState(e) {
      if (isLiveMode) return; // Ignore YouTube events in live mode
      
      const s = e.data;
      if (s === YT.PlayerState.PLAYING) {
        loader.classList.add('hide');
        setPlayState(true);
        startUpd();
      } else if (s === YT.PlayerState.PAUSED) {
        setPlayState(false);
        stopUpd();
        save();
      } else if (s === YT.PlayerState.BUFFERING) {
        loaderText.textContent = 'Buffering...';
        loader.classList.remove('hide');
      } else if (s === YT.PlayerState.ENDED) {
        loader.classList.add('hide');
        if (autoNext && idx < videos.length - 1) { idx++; loadVid(); }
        else setPlayState(false);
      } else if (s === YT.PlayerState.CUED) {
        loader.classList.add('hide');
      }
    }
    
    function onErr(e) {
      loader.classList.add('hide');
      msg('Error loading video - try next');
    }
    
    function loadVid() {
      if (!player || !ready || !videos[idx]) return;
      
      // Stop live mode if active
      if (isLiveMode) {
        stopLiveChannel();
      }
      
      loaderText.textContent = 'Loading...';
      loader.classList.remove('hide');
      updTitle();
      renderList();
      save();
      player.loadVideoById({ videoId: videos[idx].id, suggestedQuality: 'default' });
    }
    
    function updTitle() {
      const v = videos[idx];
      if (v) {
        vTitle.textContent = v.title || 'Loading...';
        vCount.textContent = (idx + 1) + '/' + videos.length;
      }
    }
    
    function save() {
      try { localStorage.setItem('vp_idx', idx.toString()); } catch(e) {}
    }
    
    // ===== CONTROLS =====
    function toggle() {
      if (isLiveMode) {
        if (hlsPlayer.paused) {
          hlsPlayer.play();
        } else {
          hlsPlayer.pause();
        }
        return;
      }
      
      if (!player || !ready) return;
      if (playing) player.pauseVideo();
      else player.playVideo();
    }
    
    function toggleMute() {
      if (isLiveMode) {
        muted = !muted;
        hlsPlayer.muted = muted;
      } else {
        if (!player || !ready) return;
        muted = !muted;
        if (muted) player.mute();
        else player.unMute();
      }
      
      if (muted) {
        icVol.style.display = 'none';
        icMute.style.display = 'block';
      } else {
        icVol.style.display = 'block';
        icMute.style.display = 'none';
      }
    }
    
    function seekBy(sec) {
      if (isLiveMode) {
        // For live, just show message
        msg('Live stream - cannot seek');
        return;
      }
      if (!player || !ready) return;
      player.seekTo(Math.max(0, player.getCurrentTime() + sec), true);
    }
    
    function seekTo(pct) {
      if (isLiveMode) return;
      if (!player || !ready || !dur) return;
      player.seekTo(dur * pct, true);
    }
    
    function cycleSpd() {
      if (isLiveMode) {
        msg('Speed control not available for live streams');
        return;
      }
      const spds = [1, 1.25, 1.5, 1.75, 2, 0.5, 0.75];
      const i = spds.indexOf(speed);
      speed = spds[(i + 1) % spds.length];
      if (player && ready) player.setPlaybackRate(speed);
      $('spdBtn').textContent = speed + 'x';
      msg('Speed: ' + speed + 'x');
    }
    
    function toggleAuto() {
      autoNext = !autoNext;
      $('autoBtn').classList.toggle('on', autoNext);
      msg('Autoplay: ' + (autoNext ? 'On' : 'Off'));
    }
    
    function toggleFS() {
      const w = $('wrap');
      if (!document.fullscreenElement) {
        (w.requestFullscreen || w.webkitRequestFullscreen || w.msRequestFullscreen).call(w);
      } else {
        (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document);
      }
    }
    
    function prev() { 
      if (isLiveMode) {
        // In live mode, go to previous live channel
        if (liveChannels.length > 1 && currentLiveChannel) {
          const currentIdx = liveChannels.findIndex(ch => ch.url === currentLiveChannel.url);
          const prevIdx = (currentIdx - 1 + liveChannels.length) % liveChannels.length;
          playLiveChannel(liveChannels[prevIdx]);
        }
        return;
      }
      idx = (idx - 1 + videos.length) % videos.length; 
      loadVid(); 
    }
    
    function next() { 
      if (isLiveMode) {
        // In live mode, go to next live channel
        if (liveChannels.length > 1 && currentLiveChannel) {
          const currentIdx = liveChannels.findIndex(ch => ch.url === currentLiveChannel.url);
          const nextIdx = (currentIdx + 1) % liveChannels.length;
          playLiveChannel(liveChannels[nextIdx]);
        }
        return;
      }
      idx = (idx + 1) % videos.length; 
      loadVid(); 
    }
    
    function openDrawer() { drawer.classList.add('open'); drawerBg.classList.add('open'); }
    function closeDrawer() { drawer.classList.remove('open'); drawerBg.classList.remove('open'); }
    
    async function manualRefresh() {
      refreshBtn.classList.add('spinning');
      msg('Refreshing playlist...');
      const changed = await loadData(false);
      refreshBtn.classList.remove('spinning');
      if (!changed) msg('Playlist is up to date');
    }
    
    async function autoRefresh() {
      try { await loadData(false); } catch (e) {}
    }
    
    // ===== PROGRESS BAR =====
    function getSeekPosition(e) {
      const rect = progBar.getBoundingClientRect();
      let clientX;
      if (e.touches && e.touches.length > 0) clientX = e.touches[0].clientX;
      else if (e.changedTouches && e.changedTouches.length > 0) clientX = e.changedTouches[0].clientX;
      else clientX = e.clientX;
      return Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    }
    
    function updateSeekPreview(pct) {
      progFill.style.width = (pct * 100) + '%';
      progThumb.style.left = (pct * 100) + '%';
      curT.textContent = fmt(dur * pct);
    }
    
    function startSeek(e) {
      if (isLiveMode) return;
      e.preventDefault();
      e.stopPropagation();
      isSeeking = true;
      progBar.classList.add('dragging');
      showUI();
      updateSeekPreview(getSeekPosition(e));
      document.addEventListener('mousemove', moveSeek);
      document.addEventListener('mouseup', endSeek);
      document.addEventListener('touchmove', moveSeek, { passive: false });
      document.addEventListener('touchend', endSeek);
      document.addEventListener('touchcancel', endSeek);
    }
    
    function moveSeek(e) {
      if (!isSeeking) return;
      e.preventDefault();
      updateSeekPreview(getSeekPosition(e));
    }
    
    function endSeek(e) {
      if (!isSeeking) return;
      seekTo(getSeekPosition(e));
      isSeeking = false;
      progBar.classList.remove('dragging');
      autoHide();
      document.removeEventListener('mousemove', moveSeek);
      document.removeEventListener('mouseup', endSeek);
      document.removeEventListener('touchmove', moveSeek);
      document.removeEventListener('touchend', endSeek);
      document.removeEventListener('touchcancel', endSeek);
    }
    
    progBar.addEventListener('mousedown', startSeek);
    progBar.addEventListener('touchstart', startSeek, { passive: false });
    progBar.addEventListener('click', e => {
      if (isSeeking || isLiveMode) return;
      e.stopPropagation();
      seekTo(getSeekPosition(e));
    });
    
    // ===== EVENTS =====
    $('playBtn').onclick = e => { e.stopPropagation(); toggle(); };
    bigPlay.onclick = e => { e.stopPropagation(); toggle(); };
    $('muteBtn').onclick = e => { e.stopPropagation(); toggleMute(); };
    $('spdBtn').onclick = e => { e.stopPropagation(); cycleSpd(); };
    $('autoBtn').onclick = e => { e.stopPropagation(); toggleAuto(); };
    $('fsBtn').onclick = e => { e.stopPropagation(); toggleFS(); };
    $('prevBtn').onclick = e => { e.stopPropagation(); prev(); };
    $('nextBtn').onclick = e => { e.stopPropagation(); next(); };
    $('listBtn').onclick = e => { e.stopPropagation(); openDrawer(); };
    $('closeDrawer').onclick = e => { e.stopPropagation(); closeDrawer(); };
    $('refreshBtn').onclick = e => { e.stopPropagation(); manualRefresh(); };
    $('searchBtn').onclick = e => { e.stopPropagation(); openSearch(); };
    $('searchClose').onclick = e => { e.stopPropagation(); closeSearch(); };
    $('searchSubmit').onclick = e => { e.stopPropagation(); performSearch(); };
    $('historyBtn').onclick = e => { e.stopPropagation(); openHistory(); };
    $('historyClose').onclick = e => { e.stopPropagation(); closeHistory(); };
    $('liveBtn').onclick = e => { e.stopPropagation(); openLive(); };
    $('liveClose').onclick = e => { e.stopPropagation(); closeLive(); };
    drawerBg.onclick = closeDrawer;
    
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); performSearch(); }
    });
    
    drawerList.onclick = e => {
      const it = e.target.closest('.pl-item');
      if (it) { idx = parseInt(it.dataset.i); loadVid(); closeDrawer(); }
    };
    
    let lastTap = 0;
    center.onclick = e => {
      if (e.target === bigPlay || e.target.closest('.play-big')) return;
      
      const now = Date.now();
      const diff = now - lastTap;
      const r = center.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width;
      
      if (diff < 300) {
        if (x < 0.35) {
          seekBy(-10);
          if (!isLiveMode) {
            tapL.classList.add('show');
            setTimeout(() => tapL.classList.remove('show'), 400);
          }
        } else if (x > 0.65) {
          seekBy(10);
          if (!isLiveMode) {
            tapR.classList.add('show');
            setTimeout(() => tapR.classList.remove('show'), 400);
          }
        } else {
          toggleFS();
        }
        lastTap = 0;
      } else {
        lastTap = now;
        setTimeout(() => {
          if (lastTap === now) {
            if (ui.classList.contains('visible') && playing) hideUI();
            else { showUI(); autoHide(); }
          }
        }, 300);
      }
    };
    
    document.querySelector('.top').onclick = () => { showUI(); autoHide(); };
    document.querySelector('.bottom').onclick = e => {
      if (e.target.closest('.prog-bar')) return;
      showUI();
      autoHide();
    };
    
    document.onkeydown = e => {
      if (e.target.tagName === 'INPUT') return;
      switch(e.key) {
        case ' ': e.preventDefault(); toggle(); break;
        case 'ArrowLeft': e.preventDefault(); seekBy(-10); msg('-10s'); break;
        case 'ArrowRight': e.preventDefault(); seekBy(10); msg('+10s'); break;
        case 'm': case 'M': toggleMute(); break;
        case 'f': case 'F': toggleFS(); break;
        case 'n': case 'N': next(); break;
        case 'p': case 'P': prev(); break;
        case 'r': case 'R': manualRefresh(); break;
        case 's': case 'S': openSearch(); break;
        case 'l': case 'L': openLive(); break;
        case 'Escape': closeSearch(); closeDrawer(); closeHistory(); closeLive(); break;
      }
    };
    
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') autoRefresh();
    });
    
    window.addEventListener('online', () => { msg('Back online!'); autoRefresh(); });
    
    // ===== PWA =====
    let deferredPrompt = null;
    const installBar = $('installBar');
    
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                  window.matchMedia('(display-mode: fullscreen)').matches ||
                  window.navigator.standalone === true;
    
    if (!isPWA) {
      window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        installBar.classList.remove('hide');
      });
    }
    
    $('installBtn').onclick = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const r = await deferredPrompt.userChoice;
      if (r.outcome === 'accepted') msg('Installed!');
      deferredPrompt = null;
      installBar.classList.add('hide');
    };
    
    $('closeInstall').onclick = () => installBar.classList.add('hide');
    
    // ===== SERVICE WORKER =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        for (let registration of registrations) registration.unregister();
      });
      setTimeout(() => {
        navigator.serviceWorker.register('sw.js?v=' + Date.now()).catch(() => {});
      }, 1000);
    }
    
    if ('caches' in window) {
      caches.keys().then(keys => { keys.forEach(key => caches.delete(key)); });
    }
    
    // ===== INIT =====
    async function init() {
      console.log('[INIT] Starting Video Player...');
      
      loadHistoryFromStorage();
      
      if (YOUTUBE_API_KEY === "YOUR_API_KEY_HERE") {
        console.warn('[INIT] YouTube API key not configured! Search will not work.');
      }
      
      await loadData(true);
      
      if (videos.length > 0) {
        loaderText.textContent = 'Loading player...';
        loadAPI();
      } else if (liveChannels.length > 0) {
        // No videos but have live channels - show live modal
        loader.classList.add('hide');
        msg('No videos found. Open Live Channels to watch live streams.');
      }
      
      setInterval(autoRefresh, AUTO_REFRESH_INTERVAL);
    }
    
    init();
  </script>
</body>
</html>
