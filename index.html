<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000">
  <title>Video Player</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      background: #000; 
      color: #fff; 
      font-family: system-ui, sans-serif;
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .player-wrap {
      position: relative;
      width: 100%;
      height: 100vh;
      background: #000;
    }
    
    #player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Simple Loading */
    .loader {
      position: absolute;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .loader.hide { display: none; }
    .loader::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Controls */
    .ui {
      position: absolute;
      inset: 0;
      z-index: 20;
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none;
    }
    .ui.show { opacity: 1; pointer-events: auto; }
    .ui.paused { opacity: 1; pointer-events: auto; }
    
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: linear-gradient(#000, transparent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .title {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    
    .counter {
      font-size: 12px;
      color: #888;
    }
    
    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px 12px;
      background: linear-gradient(transparent, #000);
    }
    
    /* Seek bar */
    .seek-wrap {
      height: 24px;
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .seek-track {
      flex: 1;
      height: 4px;
      background: #444;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .seek-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: #fff;
      border-radius: 2px;
      pointer-events: none;
    }
    
    .time {
      font-size: 11px;
      color: #aaa;
      min-width: 45px;
      font-variant-numeric: tabular-nums;
    }
    .time.end { text-align: right; }
    
    /* Buttons */
    .btn-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .btns {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 50%;
    }
    .btn:active { background: rgba(255,255,255,.1); }
    .btn svg { width: 22px; height: 22px; fill: currentColor; }
    .btn.on { color: #6366f1; }
    
    /* Center play */
    .play-big {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: rgba(255,255,255,.9);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .play-big svg { width: 30px; height: 30px; fill: #000; margin-left: 4px; }
    .ui.paused .play-big { display: flex; }
    
    /* Tap feedback */
    .tap {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,.7);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
    }
    .tap.l { left: 20%; }
    .tap.r { right: 20%; }
    .tap.show { opacity: 1; }
    
    /* Playlist */
    .drawer-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      z-index: 100;
      display: none;
    }
    .drawer-bg.open { display: block; }
    
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px;
      max-width: 80vw;
      height: 100%;
      background: #111;
      z-index: 101;
      transform: translateX(100%);
      transition: transform .2s;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    
    .drawer-head {
      padding: 14px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .drawer-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .item {
      padding: 12px 14px;
      border-bottom: 1px solid #222;
      cursor: pointer;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .item:active { background: #222; }
    .item.active { background: #1a1a2e; border-left: 3px solid #6366f1; }
    .item-num { color: #6366f1; font-weight: 600; font-size: 13px; min-width: 24px; }
    .item-title { font-size: 13px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      z-index: 200;
      pointer-events: none;
      transition: opacity .2s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="player-wrap" id="wrap">
    <div id="player"></div>
    
    <div class="loader" id="loader"></div>
    
    <div class="ui" id="ui">
      <div class="top-bar">
        <button class="btn" id="prevBtn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="btn" id="nextBtn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        <span class="title" id="title">Loading...</span>
        <span class="counter" id="counter">-/-</span>
        <button class="btn" id="listBtn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
      </div>
      
      <div class="play-big" id="playBig"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
      
      <div class="tap l" id="tapL">-10s</div>
      <div class="tap r" id="tapR">+10s</div>
      
      <div class="bottom-bar">
        <div class="seek-wrap">
          <span class="time" id="cur">0:00</span>
          <div class="seek-track" id="seekTrack">
            <div class="seek-fill" id="seekFill"></div>
          </div>
          <span class="time end" id="dur">0:00</span>
        </div>
        <div class="btn-row">
          <div class="btns">
            <button class="btn" id="playBtn">
              <svg id="iconPause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
              <svg id="iconPlay" viewBox="0 0 24 24" style="display:none"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="btn" id="muteBtn">
              <svg id="iconVol" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
              <svg id="iconMute" viewBox="0 0 24 24" style="display:none"><path d="M16.5 12A4.5 4.5 0 0014 7.97v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.796 8.796 0 0021 12c0-4.28-3-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.26c-.67.52-1.42.93-2.25 1.18v2.06a8.99 8.99 0 003.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
            </button>
          </div>
          <div class="btns">
            <button class="btn" id="speedBtn" style="font-size:12px;font-weight:600">1x</button>
            <button class="btn on" id="autoBtn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            <button class="btn" id="fsBtn"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="drawer-bg" id="drawerBg"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-head">
      <span>Playlist</span>
      <button class="btn" id="closeList"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    <div class="drawer-list" id="list"></div>
  </div>
  
  <div class="toast" id="toast"></div>

  <script>
    // Config
    const SHEET = "18vr3vEXz378zaDwWZFcIDTZ1J5xzQ0vfZQ5KjjhhXVg";
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?tqx=out:json&sheet=link`;
    
    // State
    let player, videos = [], idx = 0, playing = false, dur = 0, muted = false, auto = true, speed = 1;
    let uiTimer, seekTimer;
    
    // DOM
    const $ = id => document.getElementById(id);
    const wrap = $('wrap'), ui = $('ui'), loader = $('loader');
    const title = $('title'), counter = $('counter');
    const cur = $('cur'), durEl = $('dur'), seekTrack = $('seekTrack'), seekFill = $('seekFill');
    const playBtn = $('playBtn'), iconPlay = $('iconPlay'), iconPause = $('iconPause');
    const playBig = $('playBig'), muteBtn = $('muteBtn'), iconVol = $('iconVol'), iconMute = $('iconMute');
    const speedBtn = $('speedBtn'), autoBtn = $('autoBtn'), fsBtn = $('fsBtn');
    const prevBtn = $('prevBtn'), nextBtn = $('nextBtn'), listBtn = $('listBtn');
    const drawer = $('drawer'), drawerBg = $('drawerBg'), list = $('list'), closeList = $('closeList');
    const tapL = $('tapL'), tapR = $('tapR'), toast = $('toast');
    
    // Utils
    const fmt = t => {
      if (!t || isNaN(t)) return '0:00';
      const m = Math.floor(t / 60), s = Math.floor(t % 60);
      return m + ':' + (s < 10 ? '0' : '') + s;
    };
    
    const showToast = msg => {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    };
    
    const getVid = url => {
      if (!url) return null;
      const m = url.match(/[?&]v=([^&]+)/) || url.match(/youtu\.be\/([^?]+)/);
      return m ? m[1] : null;
    };
    
    // Load playlist
    async function load() {
      try {
        const res = await fetch(URL);
        const txt = await res.text();
        const json = JSON.parse(txt.substr(47).slice(0, -2));
        
        videos = [];
        for (const row of json.table.rows) {
          const link = row.c[1]?.v;
          if (link) {
            videos.push({
              id: getVid(link),
              title: row.c[0]?.v || 'Video ' + (videos.length + 1)
            });
          }
        }
        
        if (videos.length === 0) {
          loader.innerHTML = '<div style="text-align:center"><p>No videos found</p><button onclick="location.reload()" style="margin-top:10px;padding:8px 16px;background:#333;border:none;color:#fff;border-radius:6px">Retry</button></div>';
          return;
        }
        
        // Load saved index
        try {
          const saved = localStorage.getItem('vpIdx');
          if (saved) idx = Math.min(parseInt(saved), videos.length - 1);
        } catch(e) {}
        
        renderList();
        initPlayer();
      } catch(e) {
        loader.innerHTML = '<div style="text-align:center"><p>Failed to load</p><button onclick="location.reload()" style="margin-top:10px;padding:8px 16px;background:#333;border:none;color:#fff;border-radius:6px">Retry</button></div>';
      }
    }
    
    // Render playlist
    function renderList() {
      list.innerHTML = videos.map((v, i) => 
        `<div class="item${i === idx ? ' active' : ''}" data-i="${i}">
          <span class="item-num">${i + 1}</span>
          <span class="item-title">${v.title}</span>
        </div>`
      ).join('');
    }
    
    // YouTube Player
    function initPlayer() {
      if (!window.YT || !window.YT.Player) {
        setTimeout(initPlayer, 100);
        return;
      }
      
      player = new YT.Player('player', {
        videoId: videos[idx].id,
        playerVars: {
          controls: 0,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          autoplay: 1,
          fs: 0
        },
        events: {
          onReady: onReady,
          onStateChange: onState
        }
      });
    }
    
    function onReady() {
      dur = player.getDuration();
      durEl.textContent = fmt(dur);
      loader.classList.add('hide');
      showUI();
      startSeek();
    }
    
    function onState(e) {
      const s = e.data;
      
      if (s === YT.PlayerState.PLAYING) {
        playing = true;
        iconPlay.style.display = 'none';
        iconPause.style.display = 'block';
        ui.classList.remove('paused');
        loader.classList.add('hide');
        startSeek();
        autoHideUI();
      } 
      else if (s === YT.PlayerState.PAUSED) {
        playing = false;
        iconPlay.style.display = 'block';
        iconPause.style.display = 'none';
        ui.classList.add('paused');
        stopSeek();
        try { localStorage.setItem('vpIdx', idx); } catch(e) {}
      } 
      else if (s === YT.PlayerState.BUFFERING) {
        loader.classList.remove('hide');
      } 
      else if (s === YT.PlayerState.ENDED) {
        if (auto && idx < videos.length - 1) {
          idx++;
          playVideo();
        }
      }
    }
    
    function playVideo() {
      if (!player || !videos[idx]) return;
      loader.classList.remove('hide');
      title.textContent = videos[idx].title;
      counter.textContent = (idx + 1) + '/' + videos.length;
      renderList();
      player.loadVideoById(videos[idx].id);
      try { localStorage.setItem('vpIdx', idx); } catch(e) {}
    }
    
    // Seek updates - only when playing
    function startSeek() {
      stopSeek();
      seekTimer = setInterval(updateSeek, 500);
    }
    
    function stopSeek() {
      if (seekTimer) clearInterval(seekTimer);
    }
    
    function updateSeek() {
      if (!player || !player.getCurrentTime) return;
      const t = player.getCurrentTime();
      dur = player.getDuration() || dur;
      const pct = dur > 0 ? (t / dur) * 100 : 0;
      seekFill.style.width = pct + '%';
      cur.textContent = fmt(t);
      durEl.textContent = fmt(dur);
    }
    
    // UI visibility
    function showUI() {
      ui.classList.add('show');
      clearTimeout(uiTimer);
    }
    
    function hideUI() {
      if (playing) ui.classList.remove('show');
    }
    
    function autoHideUI() {
      clearTimeout(uiTimer);
      if (playing) uiTimer = setTimeout(hideUI, 3000);
    }
    
    // Controls
    function togglePlay() {
      if (!player) return;
      playing ? player.pauseVideo() : player.playVideo();
    }
    
    function toggleMute() {
      if (!player) return;
      muted = !muted;
      muted ? player.mute() : player.unMute();
      iconVol.style.display = muted ? 'none' : 'block';
      iconMute.style.display = muted ? 'block' : 'none';
    }
    
    function cycleSpeed() {
      const speeds = [1, 1.25, 1.5, 1.75, 2, 0.5, 0.75];
      const i = speeds.indexOf(speed);
      speed = speeds[(i + 1) % speeds.length];
      player?.setPlaybackRate(speed);
      speedBtn.textContent = speed + 'x';
      showToast('Speed: ' + speed + 'x');
    }
    
    function toggleAuto() {
      auto = !auto;
      autoBtn.classList.toggle('on', auto);
      showToast('Autoplay: ' + (auto ? 'On' : 'Off'));
    }
    
    function toggleFS() {
      if (!document.fullscreenElement) {
        wrap.requestFullscreen?.() || wrap.webkitRequestFullscreen?.();
      } else {
        document.exitFullscreen?.() || document.webkitExitFullscreen?.();
      }
    }
    
    function seek(delta) {
      if (!player) return;
      player.seekTo(player.getCurrentTime() + delta, true);
    }
    
    function seekTo(pct) {
      if (!player || !dur) return;
      player.seekTo(dur * pct, true);
    }
    
    function openDrawer() {
      drawer.classList.add('open');
      drawerBg.classList.add('open');
    }
    
    function closeDrawer() {
      drawer.classList.remove('open');
      drawerBg.classList.remove('open');
    }
    
    // Event listeners
    playBtn.onclick = togglePlay;
    playBig.onclick = togglePlay;
    muteBtn.onclick = toggleMute;
    speedBtn.onclick = cycleSpeed;
    autoBtn.onclick = toggleAuto;
    fsBtn.onclick = toggleFS;
    
    prevBtn.onclick = () => { idx = (idx - 1 + videos.length) % videos.length; playVideo(); };
    nextBtn.onclick = () => { idx = (idx + 1) % videos.length; playVideo(); };
    
    listBtn.onclick = openDrawer;
    closeList.onclick = closeDrawer;
    drawerBg.onclick = closeDrawer;
    
    list.onclick = e => {
      const item = e.target.closest('.item');
      if (item) {
        idx = parseInt(item.dataset.i);
        playVideo();
        closeDrawer();
      }
    };
    
    // Seek bar
    seekTrack.onclick = e => {
      const rect = seekTrack.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      seekTo(Math.max(0, Math.min(1, pct)));
    };
    
    // Touch / tap handling
    let lastTap = 0;
    
    wrap.onclick = e => {
      if (e.target.closest('.top-bar') || e.target.closest('.bottom-bar') || e.target.closest('.play-big')) {
        showUI();
        autoHideUI();
        return;
      }
      
      const now = Date.now();
      const rect = wrap.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      
      if (now - lastTap < 300) {
        // Double tap
        if (x < 0.35) {
          seek(-10);
          tapL.classList.add('show');
          setTimeout(() => tapL.classList.remove('show'), 400);
        } else if (x > 0.65) {
          seek(10);
          tapR.classList.add('show');
          setTimeout(() => tapR.classList.remove('show'), 400);
        } else {
          toggleFS();
        }
      } else {
        // Single tap - toggle UI
        if (ui.classList.contains('show') && playing) {
          hideUI();
        } else {
          showUI();
          autoHideUI();
        }
      }
      lastTap = now;
    };
    
    // Keyboard
    document.onkeydown = e => {
      if (e.target.tagName === 'INPUT') return;
      switch(e.key) {
        case ' ': e.preventDefault(); togglePlay(); break;
        case 'ArrowLeft': seek(-10); break;
        case 'ArrowRight': seek(10); break;
        case 'ArrowUp': player?.setVolume(Math.min(100, player.getVolume() + 10)); break;
        case 'ArrowDown': player?.setVolume(Math.max(0, player.getVolume() - 10)); break;
        case 'm': case 'M': toggleMute(); break;
        case 'f': case 'F': toggleFS(); break;
        case 'n': case 'N': nextBtn.click(); break;
        case 'p': case 'P': prevBtn.click(); break;
      }
    };
    
    // Load YouTube API
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
    
    window.onYouTubeIframeAPIReady = () => {
      if (videos.length > 0) initPlayer();
    };
    
    // Start
    load();
  </script>
</body>
</html>
